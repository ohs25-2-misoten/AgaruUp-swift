name: CI

on:
  pull_request:
    branches: [ main, develop ]

jobs:
  test:
    name: Test
    runs-on: macos-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Xcode
        run: |
          sudo xcode-select --switch /Applications/Xcode.app/Contents/Developer
          xcodebuild -version
      
      - name: Run unit tests
        run: |
          xcodebuild test \
            -scheme AgaruUp \
            -destination 'platform=iOS Simulator,name=iPhone 15' \
            -derivedDataPath .build \
            -enableCodeCoverage YES \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO
      
      - name: Run UI tests
        run: |
          xcodebuild test \
            -scheme AgaruUp \
            -destination 'platform=iOS Simulator,name=iPhone 15' \
            -derivedDataPath .build \
            -only-testing AgaruUpUITests \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO
  
  build:
    name: Build
    runs-on: macos-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Xcode
        run: |
          sudo xcode-select --switch /Applications/Xcode.app/Contents/Developer
          xcodebuild -version
      
      - name: Build app
        run: |
          xcodebuild build \
            -scheme AgaruUp \
            -destination 'generic/platform=iOS' \
            -derivedDataPath .build \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO

  lint:
    name: Lint
    runs-on: macos-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Run SwiftLint
        run: |
          if ! command -v swiftlint &> /dev/null; then
            brew install swiftlint
          fi
          swiftlint lint --strict
